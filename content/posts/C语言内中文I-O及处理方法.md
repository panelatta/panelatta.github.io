---
categories:
- Programming Languages
- C
date: '2020-06-07T20:43:47+08:00'
tags:
- ä¸­æ–‡å¤„ç†
- ç¼–ç 
title: Cè¯­è¨€å†…ä¸­æ–‡I/OåŠå¤„ç†æ–¹æ³•
toc: true
---

Cè¯­è¨€å†…å¤„ç†ä¸åŒçš„å­—ç¬¦ç¼–ç ä¸€ç›´æ˜¯ä¸ªé‡è¦é—®é¢˜ï¼Œæ­£å¥½ä»Šå¤©é‡åˆ°äº†éœ€è¦å¤„ç†è¯»å–/è¾“å‡ºä¸­æ–‡çš„é—®é¢˜ï¼ŒæŠŠç ”ç©¶ç»“æœåœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚

<!--more-->

## `wchar_t` ç±»å‹

### è¯´æ˜

å®šä¹‰äºå¤´æ–‡ä»¶ `wchar.h` å†…ï¼Œå­˜å‚¨å®½å­—ç¬¦ç±»å‹ï¼›`wchar_t` ç±»å‹çš„å®½å­—ç¬¦ä¸²å¯ä¸ä½¿ç”¨ `char` ç±»å‹çš„å¤šå­—èŠ‚å­—ç¬¦ä¸²äº’ç›¸è½¬æ¢ã€‚

å®½å­—ç¬¦ä¸²å­—é¢é‡åœ¨å­—é¢é‡å‰åŠ  `L` æ ‡è®°ã€‚*e.g.* `L"s-char-sequence"`

#### ç›¸å…³ç±»å‹

`wint_t` ç±»å‹æ˜¯å¯ä¿æœ‰ä»»ä½•åˆæ³•å®½å­—ç¬¦ï¼Œå¹¶è‡³å°‘å¤šå‡ºä¸€ä¸ªå€¼çš„æ•´æ•°ç±»å‹ ã€‚

### I/O å‡½æ•°

> æœ¬èŠ‚å‚è€ƒè‡ªä¸­æ–‡ cppreference çš„[æ–‡ä»¶è¾“å…¥/è¾“å‡º](https://zh.cppreference.com/w/c/io)ä¸€èŠ‚ã€‚

#### æ— æ ¼å¼ I/O

|      å‡½æ•°å      |                          å‡½æ•°åŸå‹                           |           è¯´æ˜            |
| :--------------: | :---------------------------------------------------------: | :-----------------------: |
| `fgetwc`/`getwc` |              `wint_t fgetwc( FILE *stream );`               |  ä»æ–‡ä»¶æµè·å–ä¸€ä¸ªå®½å­—ç¬¦   |
|     `fgetws`     | `wchar_t *fgetws( wchar_t *str, int count, FILE *stream );` | ä»æ–‡ä»¶æµè·å–ä¸€ä¸ªå®½å­—ç¬¦ä¸²  |
|  `fputwc/putwc`  |        `wint_t fputwc( wchar_t ch, FILE *stream );`         |  å°†ä¸€ä¸ªå®½å­—ç¬¦å†™å…¥æ–‡ä»¶æµ   |
|     `fputws`     |      `int fputws( const wchar_t *str, FILE *stream );`      | å°†ä¸€ä¸ªå®½å­—ç¬¦ä¸²å†™å…¥æ–‡ä»¶æµ  |
|    `getwchar`    |                  `wint_t getwchar(void);`                   | ä» `stdin` è¯»å–ä¸€ä¸ªå®½å­—ç¬¦ |
|    `putwchar`    |              `wint_t putwchar( wchar_t ch );`               | å°†ä¸€ä¸ªå®½å­—ç¬¦å†™å…¥`stdout`  |
|    `ungetwc`     |        `wint_t ungetwc( wint_t ch, FILE *stream );`         |  å°†ä¸€ä¸ªå®½å­—ç¬¦é€å›æ–‡ä»¶æµ   |

#### æœ‰æ ¼å¼ I/O

##### `wscanf` ç³»åˆ—

|  å‡½æ•°å   |                           å‡½æ•°åŸå‹                           |              è¯´æ˜               |
| :-------: | :----------------------------------------------------------: | :-----------------------------: |
| `wscanf`  |         `int wscanf( const wchar_t *format, ... );`          | ä» `stdin` è¯»å–æ ¼å¼åŒ–å®½å­—ç¬¦è¾“å…¥ |
| `fwscanf` |  `int fwscanf( FILE *stream, const wchar_t *format, ... );`  |  ä»æ–‡ä»¶æµè¯»å–æ ¼å¼åŒ–å®½å­—ç¬¦è¾“å…¥   |
| `swscanf` | `int swscanf( const wchar_t *buffer, const wchar_t *format, ... );` |  ä»ç¼“å†²åŒºè¯»å–æ ¼å¼åŒ–å®½å­—ç¬¦è¾“å…¥   |

##### `wprintf` ç³»åˆ—

|   å‡½æ•°å   |                           å‡½æ•°åŸå‹                           |           è¯´æ˜            |
| :--------: | :----------------------------------------------------------: | :-----------------------: |
| `wprintf`  |         `int wprintf( const wchar_t *format, ... );`         | æ‰“å°æ ¼å¼åŒ–è¾“å‡ºåˆ° `stdout` |
| `fwprintf` | `int fwprintf( FILE *stream, const wchar_t* format, ... );`  |  æ‰“å°æ ¼å¼åŒ–è¾“å‡ºåˆ°æ–‡ä»¶æµ   |
| `swprintf` | `int swprintf( wchar_t *buffer, size_t bufsz, const wchar_t* format, ... );` |  æ‰“å°æ ¼å¼åŒ–è¾“å‡ºåˆ°ç¼“å†²åŒº   |

##### æ ¼å¼åŒ–è¯´æ˜ç¬¦ä¸ä½¿ç”¨æ–¹å¼

| æ ¼å¼åŒ–è¯´æ˜ç¬¦ |         è¯´æ˜          |
| :----------: | :-------------------: |
|    `%lc`     |  å¯¹åº” `wint_t` ç±»å‹   |
|    `%ls`     | å¯¹åº” `wchar_t *` ç±»å‹ |

`wscanf`/`wprintf` ç³»åˆ—ä¸­çš„ `format` å‚æ•°è‹¥æ˜¯å®½å­—ç¬¦ä¸²å­—é¢é‡ï¼Œäº¦é¡»ç¡®ä¿åŠ ä¸Šäº†å¯¹åº”çš„ `L` æ ‡è®°ã€‚

`swprintf` ä¸­çš„ `bufsz` å‚æ•°ä¿è¯æœ€å¤šä¼šå†™å…¥ `bufsz - 1` ä¸ªå®½å­—ç¬¦ï¼Œå†åŠ ç©ºç»ˆæ­¢ç¬¦ã€‚

**æ³¨æ„ï¼šè‹¥ `wscanf` ç³»åˆ—å‡½æ•°åœ¨èµ‹å€¼é¦–ä¸ªæ¥æ”¶å‚æ•°å‰å‡ºç°è¯»å–å¤±è´¥ï¼Œè¿”å›å€¼ä»ä¸º `EOF` è€Œé `wchar.h` ä¸­å®šä¹‰çš„å® `WEOF` ã€‚**

##### ç¤ºä¾‹

```c
#include <locale.h>
#include <wchar.h>
 
int main(void)
{
    char narrow_str[] = "z\u00df\u6c34\U0001f34c";
                    // æˆ– "zÃŸæ°´ğŸŒ"
                    // æˆ– "\x7a\xc3\x9f\xe6\xb0\xb4\xf0\x9f\x8d\x8c";
    wchar_t warr[29]; // æœŸå¾…çš„å­—ç¬¦ä¸²ä¸º 28 å­—èŠ‚åŠ  1 ä¸ªç©ºç»ˆæ­¢ç¬¦
    setlocale(LC_ALL, "en_US.utf8");
    swprintf(warr, sizeof warr/sizeof *warr,
              L"Converted from UTF-8: '%s'", narrow_str);
    wprintf(L"%ls\n", warr);
}
```

#### çª„å­—ç¬¦ `scanf`/`printf` ç³»åˆ—å‡½æ•°å¯¹å®½å­—ç¬¦ï¼ˆä¸²ï¼‰çš„å¤„ç†

> æœ¬èŠ‚å†…å®¹å‚è€ƒè‡ª[æµ…è°ˆCä¸­çš„wprintfå’Œå®½å­—ç¬¦æ˜¾ç¤º](https://blog.csdn.net/lovekatherine/article/details/1868724)ã€‚

çª„å­—ç¬¦ä¹‹ `scanf`/`printf` ç³»åˆ—å‡½æ•°äº¦å¯ä½¿ç”¨ `%ls`/`%lc` æ ¼å¼è¯´æ˜ç¬¦æ¥å¤„ç† `wchar_t *`/`wchar_t` ç±»å‹ã€‚ä½†ç”±äº `scanf`/`printf` ç³»åˆ—å‡½æ•°ç”¨äº byte streamï¼Œå…¶è¾“å…¥/è¾“å‡ºæµä¸­çš„æ¯ä¸ªå­—ç¬¦å  `1 byte`ï¼›`wscanf`/`wprintf` ç³»åˆ—å‡½æ•°ç”¨äº wide streamï¼Œå…¶è¾“å…¥/è¾“å‡ºæµä¸­çš„æ¯ä¸ªå­—ç¬¦å¤šäº `1 byte`ï¼Œæ•…å…¶æœ‰åŒºåˆ«å¦‚ä¸‹ï¼š

|            ç»„åˆ            |                             è¯´æ˜                             |
| :------------------------: | :----------------------------------------------------------: |
|  `scanf`/`printf` + `%s`   | `scanf`/`printf`å°†å°†æŒ‡é’ˆå¯¹åº”ç¼“å†²åŒºä¸­çš„å†…å®¹è§†ä½œæ™®é€šå­—ç¬¦ä¸²ï¼Œä¹‹åé€ä¸ªå­—èŠ‚è¾“å‡º |
|  `scanf`/`printf` + `%ls`  | `scanf`/`printf` å°†æŒ‡é’ˆå¯¹åº”ç¼“å†²åŒºä¸­çš„å†…å®¹è§†ä½œå®½å­—ç¬¦ä¸²ï¼ŒæŒ‰ç…§ `locale` çš„è®¾å®šï¼Œå°†å…¶ä¸­çš„æ¯ä¸ªå­—ç¬¦éšå¼è°ƒç”¨ `wcrtomb()` å‡½æ•°å°†å…¶è½¬æ¢æˆå¤šå­—èŠ‚å­—ç¬¦ä¸²ï¼Œä¹‹åé€ä¸ªå­—èŠ‚è¾“å‡º |
| `wscanf`/`wprintf` + `%s`  | `wscanf`/`wprintf` å°†æŒ‡é’ˆå¯¹åº”ç¼“å†²åŒºä¸­çš„å†…å®¹è§†ä½œæ™®é€šå­—ç¬¦ä¸²ï¼ŒæŒ‰ç…§ `locale` çš„è®¾å®šï¼Œå°†å…¶ä¸­çš„æ¯ä¸ªå­—ç¬¦éšå¼è°ƒç”¨ `mbrtowc()` å‡½æ•°å°†å…¶è½¬æ¢æˆå®½å­—ç¬¦ä¸²ï¼Œä¹‹åé€ä¸ªå®½å­—ç¬¦è¾“å‡º |
| `wscanf`/`wprintf` + `%ls` | `wscanf`/`wprintf` å°†æŒ‡é’ˆå¯¹åº”ç¼“å†²åŒºä¸­çš„å†…å®¹è§†ä½œå®½å­—ç¬¦ä¸²ï¼Œä¹‹åé€ä¸ªå®½å­—ç¬¦è¾“å‡º |

#### æ–‡ä»¶è¯»å†™

> æœ¬èŠ‚å†…å®¹å‚è€ƒè‡ª [Linux Manual Page](https://www.man7.org/linux/man-pages/man3/fopen.3.html) å’Œ [Visual Studio 2019 æ–‡æ¡£](https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/fopen-wfopen?view=vs-2019)ã€‚

Cè¯­è¨€æ²¡æœ‰å¤„ç†å®½å­—ç¬¦ä¸²æˆ–å…¶ä»–ç¼–ç çš„ç‰¹æ®Šæ–‡ä»¶I/Oå‡½æ•°ï¼Œè‹¥éœ€æŒ‡å®šé‡‡ç”¨ç‰¹æ®Šç¼–ç è¯»å†™æ–‡ä»¶ï¼Œéœ€é‡‡ç”¨ä¸€ä¸ªgcc/msvcæ‰©å±•ï¼Œåœ¨è¯»å†™æ¨¡å¼å­—ç¬¦ä¸² `flag` æœ«å°¾åŠ å…¥é¢å¤–çš„ `,ccs=encoding` å­—æ®µæ¥æŒ‡ç¤ºè¯»å–æ–‡ä»¶æ‰€ç”¨ç¼–ç ã€‚

å½“ `encoding` ä¸º UTF-8 æ—¶ï¼Œåº”å½“ä½¿ç”¨ `,ccs=utf-8`ã€‚

##### ç¤ºä¾‹

```c
FILE *fp = fopen("test.in", "r, ccs=utf-8");
fgetws(s, 2047, fp);
wprintf(L"%ls\n", s);
fclose(fp);
```

### å…¶ä»–ç›¸å…³å‡½æ•°

> æœ¬èŠ‚å†…å®¹å‚è€ƒè‡ªä¸­æ–‡ cppreference çš„ [ç©ºç»ˆæ­¢å®½å­—ç¬¦ä¸²](https://zh.cppreference.com/w/c/string/wide)ã€‚

é™äºç¯‡å¹…ï¼Œä»¥ä¸‹åªåˆ—å‡ºå¸¸ç”¨å‡½æ•°ã€‚

#### å­—ç¬¦ä¸²æ“ä½œ

|  å‡½æ•°å   |                           å‡½æ•°åŸå‹                           |                    è¯´æ˜                    |
| :-------: | :----------------------------------------------------------: | :----------------------------------------: |
| `wcscpy`  |   `wchar_t *wcscpy( wchar_t *dest, const wchar_t *src );`    |         å°†ä¸€ä¸ªå®½å­—ç¬¦ä¸²å¤åˆ¶ç»™å¦ä¸€ä¸ª         |
| `wcsncpy` | `wchar_t* wcsncpy( wchar_t* dest, const wchar_t* src, size_t count );` |  å°†ä¸€å®šé‡çš„å®½å­—ç¬¦ä»ä¸€ä¸ªå­—ç¬¦ä¸²å¤åˆ¶åˆ°å¦ä¸€ä¸ª  |
| `wcscat`  |   `wchar_t *wcscat( wchar_t *dest, const wchar_t *src );`    |      å°†ä¸€ä¸ªå®½å­—ç¬¦ä¸²çš„å‰¯æœ¬åé™„äºå¦ä¸€ä¸ª      |
| `wcsncat` | `wchar_t *wcsncat( wchar_t *dest, const wchar_t *src, size_t count );` | å°†ä¸€å®šé‡å®½å­—ç¬¦ä¸²ä»ä¸€ä¸ªå®½å­—ç¬¦ä¸²åé™„åˆ°å¦ä¸€ä¸ª |

#### å­—ç¬¦ä¸²æ£€éªŒ

|  å‡½æ•°å   |                           å‡½æ•°åŸå‹                           |                             è¯´æ˜                             |
| :-------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| `wcslen`  |            `size_t wcslen( const wchar_t *str );`            |                      è¿”å›å®½å­—ç¬¦ä¸²çš„é•¿åº¦                      |
| `wcscmp`  |   `int wcscmp( const wchar_t *lhs, const wchar_t *rhs );`    |                       æ¯”è¾ƒä¸¤ä¸ªå®½å­—ç¬¦ä¸²                       |
| `wcsncmp` | `int wcsncmp( const wchar_t* lhs, const wchar_t* rhs, size_t count );` |               æ¯”è¾ƒæ¥è‡ªä¸¤ä¸ªå®½å­—ç¬¦ä¸²çš„ä¸€å®šé‡å­—ç¬¦               |
| `wcsstr`  | `wchar_t* wcsstr( const wchar_t* dest, const wchar_t* src );` | åœ¨ `dest` æ‰€æŒ‡çš„ç©ºç»ˆæ­¢å®½å­—ç¬¦ä¸²ä¸­ï¼Œå¯»æ‰¾ `src` æ‰€æŒ‡çš„ç©ºç»ˆæ­¢å®½å­—ç¬¦ä¸²çš„é¦–æ¬¡å‡ºç° |
| `wcstok`  | `wchar_t* wcstok( wchar_t* str, const wchar_t* delim, wchar_t **ptr );` | å¯»æ‰¾ `str` æ‰€æŒ‡å‘çš„ç©ºç»ˆæ­¢å®½å­—ç¬¦ä¸²ä¸­çš„ä¸‹ä¸ªè®°å·ã€‚ä»¥ `delim` æ‰€æŒ‡å‘çš„ç©ºç»ˆæ­¢å®½å­—ç¬¦ä¸²é‰´åˆ«åˆ†éš”ç¬¦ |

#### å®½å­—ç¬¦æ•°ç»„æ“ä½œ

|  å‡½æ•°å   |                           å‡½æ•°åŸå‹                           |                   è¯´æ˜                   |
| :-------: | :----------------------------------------------------------: | :--------------------------------------: |
| `wmemcpy` | `wchar_t* wmemcpy( wchar_t* dest, const wchar_t* src, size_t count );` | åœ¨ä¸¤ä¸ªä¸é‡å çš„æ•°ç»„é—´å¤åˆ¶ä¸€å®šæ•°é‡çš„å®½å­—ç¬¦ |
| `wmemset` | `wchar_t *wmemset( wchar_t *dest, wchar_t ch, size_t count );` | å°†ç»™å®šçš„å®½å­—ç¬¦å¤åˆ¶åˆ°å®½å­—ç¬¦æ•°ç»„çš„æ‰€æœ‰ä½ç½® |

## `locale` è®¾ç½®

é‡‡ç”¨ `setlocale(LC_ALL, "chs");` å°†å½“å‰ `locale` è®¾ç½®ä¸ºä¸­æ–‡ç¯å¢ƒå³å¯ã€‚
